@model API.Models.AdminEmployee

@{
    ViewData["Title"] = "Employee List";
}

<div class="container">
    <h1 class="mt-5 mb-4">Employee List</h1>

    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="EmpTable">
            <thead class="thead-dark">
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Shift</th>
                    <th>Department</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <div>
        <h1>Update Employee Data</h1>
        <form method="post" id="employeeForm" enctype="multipart/form-data">
            <div class="form-group">
                <label asp-for="c_empid" class="control-label">Employee id:</label>
                <input name="c_empid" id="c_empid" class="form-control" />

            </div>
            <div class="form-group">
                <label asp-for="c_empname" class="control-label">Employee Name:</label>
                <input name="c_empname" id="c_empname" class="form-control" />
            </div>

            <div class="form-group">
                <label>Shift:</label><br>
                <label class="checkbox-label"><input type="checkbox" id="morning" name="shift"
                        value="Morning">Morning</label>
                <label class="checkbox-label"><input type="checkbox" id="afternoon" name="shift"
                        value="Afternoon">Afternoon</label>
            </div>

            <div class="form-group">
                <label asp-for="c_dept_id" class="control-label">Department:</label>
                <select id="c_dept_id" name="c_dept_id" class="form-control">
                    <option value="">Select Department</option>
                </select>
            </div>

            <div class="form-group">
                <input type="submit" class="btn btn-primary" />
            </div>
        </form>

    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    $(document).ready(function () {
        loadEmp();

    });
    loadDept();

    function loadEmp() {
        $.ajax({
            url: 'https://localhost:7072/api/AdminApi',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                var EmpTable = $('#EmpTable tbody');
                EmpTable.empty();
                data.forEach(function (emp) {
                    var row = `<tr>
                    <td>${emp.c_empid}</td>
                    <td>${emp.c_empname}</td>
                    <td>${emp.c_shift}</td>
                    <td>${emp.c_deptname.c_deptname}</td>
                    <td>
                        <button type="button" onclick="loadEmployee(${emp.c_empid})" class="btn btn-primary">Edit</button>
                    </td>
                </tr>`;
                    EmpTable.append(row);
                });
            }
        });
    }



    function loadEmployee(employeeId) {
        loadDept();
        $.ajax({
            url: 'https://localhost:7072/api/AdminApi/' + employeeId,
            type: 'GET',
            success: function (data) {
                console.log(data);
                $('#c_empid').val(data.c_empid);
                $('#c_empname').val(data.c_empname);
                var shift = data.c_shift.split(',');
                shift.forEach(function (shift) {
                    $('input[name="shift"][value="' + shift + '"]').prop('checked', true);
                });
                $('#c_dept_id').val(data.c_dept_id);
                $('#c_dept_id').change();
            }
        });

    }

    function loadDept() {
        $.ajax({
            url: 'https://localhost:7072/api/AdminApi/departments',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                var DeptDropdown = $('#c_dept_id');
                DeptDropdown.empty();
                DeptDropdown.append($('<option>').val('').text('Select Department'));

                data.forEach(function (dept) {
                    DeptDropdown.append($('<option>').val(dept.c_deptid).text(dept.c_deptname));
                });
            }
        });
    }


    document.getElementById('employeeForm').addEventListener('submit', function (event) {
        event.preventDefault();
        var form = document.getElementById('employeeForm');
        var formData = new FormData(form);

        var shifts = [];
        $('input[name="shift"]:checked').each(function () {
            shifts.push($(this).val());
        });

        formData.append("c_shift", shifts.join(','));
        console.log(formData);


        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        fetch('https://localhost:7072/api/AdminApi', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to updated employee.');
                }
            })
            .then(data => {
                console.log(data);
                alert("Employee updated successfully!");
                window.location.href = '/MvcAdmin/Index';
            })
            .catch(error => {
                console.error('Error updated employee:', error.message);
                alert("Failed to Update employee.");
            });
    });


    var inactivityTimeout;

    function resetInactivityTimer() {
        clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(function () {
            window.location.href = '/User/Login'; // Redirect to the login page after inactivity
        }, 300000); // 5 minutes timeout (300,000 milliseconds)
    }

    // Attach event handlers for user activity (e.g., mousemove, keydown)
    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keydown', resetInactivityTimer);

    // Initialize the inactivity timer on page load
    resetInactivityTimer();
</script>
